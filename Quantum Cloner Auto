local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local backpack = player:WaitForChild("Backpack")

local toolName = "Quantum Cloner"

-- RemoteEvents originales
local useItemEvent = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/UseItem")
local teleportEvent = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/QuantumCloner/OnTeleport")

local debounce = false

local function forceEquipQuantumCloner()
    -- Guardar Tool actual en la mano si existe
    local currentTool = character:FindFirstChildOfClass("Tool")
    if currentTool then
        currentTool.Parent = backpack
    end

    -- Equipar Quantum Cloner
    local cloner = backpack:FindFirstChild(toolName)
    if not cloner then
        warn("No tienes el Quantum Cloner en mochila.")
        return nil, currentTool
    end
    cloner.Parent = character

    -- Esperar que el juego lo reconozca como equipado
    local timer = 0
    while cloner.Parent ~= character and timer < 1 do
        RunService.Heartbeat:Wait()
        timer = timer + RunService.Heartbeat:Wait()
    end

    return cloner, currentTool
end

local function cloneAndTeleport()
    if debounce then return end
    debounce = true

    local cloner, previousTool = forceEquipQuantumCloner()
    if not cloner then
        debounce = false
        return
    end

    task.wait(0.2) -- asegurar que esté activo

    -- 1) Clonar
    useItemEvent:FireServer()

    task.wait(0.2) -- esperar a que el clon aparezca

    -- 2) Teletransportar al clon
    teleportEvent:FireServer()

    task.wait(0.1)

    -- 3) Devolver Quantum Cloner a la mochila
    if cloner and cloner.Parent == character then
        cloner.Parent = backpack
    end

    -- 4) Volver a equipar el Tool anterior si existía
    if previousTool then
        previousTool.Parent = character
    end

    task.wait(0.3) -- cooldown
    debounce = false
end

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.F then
        cloneAndTeleport()
    end
end)
